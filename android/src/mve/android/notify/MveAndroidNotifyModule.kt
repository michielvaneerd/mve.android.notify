/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * TiDev Titanium Mobile
 * Copyright TiDev, Inc. 04/07/2022-Present
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 *
 */

package mve.android.notify

import android.Manifest
import android.app.AlarmManager
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.icu.util.Calendar
import android.os.Build
import androidx.annotation.RequiresApi
import org.appcelerator.kroll.KrollModule
import org.appcelerator.kroll.KrollDict
import org.appcelerator.kroll.annotations.Kroll
import org.appcelerator.kroll.common.Log
import org.appcelerator.kroll.common.TiConfig
import org.appcelerator.titanium.TiApplication
import java.text.SimpleDateFormat

const val channelId = "channel";
val DBG = TiConfig.LOGD
const val LCAT = "MveAndroidNotifyModule"

@Kroll.module(name = "MveAndroidNotify", id = "mve.android.notify")
class MveAndroidNotifyModule: KrollModule() {

	// NOTE: You can develop Titanium Android modules in Android Studio. Follow these three steps:
	//   1. Build the empty module
	//   2. Drag the "build" folder into Android Studio
	//   3. Start developing! All dependencies and code completions are supported!

	companion object {

		const val NOTIFICATION_REQUEST_CODE = "requestCode"
		const val NOTIFICATION_CONTENT = "content"
		const val NOTIFICATION_TITLE = "title"
		const val NOTIFICATION_ICON = "icon"
		const val NOTIFICATION_HOUR = "hour"
		const val NOTIFICATION_MINUTE = "minute"
		const val NOTIFICATION_INTERVAL = "interval"
		const val NOTIFICATION_INTERVAL_DAILY = "daily"
		const val NOTIFICATION_INTERVAL_WEEKLY = "weekly"
		const val NOTIFICATION_INTERVAL_4_WEEKLY = "4weekly"

		
		// You can define constants with @Kroll.constant, for example:
		// @Kroll.constant private val EXTERNAL_NAME = "EXTERNAL_NAME"

		@Kroll.onAppCreate
		fun onAppCreate(app: TiApplication?) {

		}
	}

	@Kroll.method
	fun createChannel() {
		if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
			Utils.log("Create notification channel")
			val name: CharSequence = "default";
			val notificationChannel = NotificationChannel(channelId, name, NotificationManager.IMPORTANCE_DEFAULT)
			val notificationManager = TiApplication.getInstance().applicationContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
			notificationManager.createNotificationChannel(notificationChannel)
		}
	}

	@RequiresApi(Build.VERSION_CODES.N)
	@Kroll.method
	fun schedule(arg: KrollDict) {

		val requestCode = arg.getInt(NOTIFICATION_REQUEST_CODE)
		val title = arg.getString(NOTIFICATION_TITLE)
		val content = arg.getString(NOTIFICATION_CONTENT)
		val icon = arg.getString(NOTIFICATION_ICON)
		val hour = arg.getInt(NOTIFICATION_HOUR)
		val minute = arg.getInt(NOTIFICATION_MINUTE)
		val intervalInMs = when (arg.getString(NOTIFICATION_INTERVAL)) {
			NOTIFICATION_INTERVAL_WEEKLY -> AlarmManager.INTERVAL_DAY * 7
			NOTIFICATION_INTERVAL_4_WEEKLY -> AlarmManager.INTERVAL_DAY * 28
			else -> AlarmManager.INTERVAL_DAY
		}

		Utils.log("Going to schedule notification for requestCode $requestCode")

		val context = TiApplication.getInstance().applicationContext;

		var infoIntent = Intent(context, MveAlarmReceiver::class.java)
		infoIntent.putExtra(NOTIFICATION_REQUEST_CODE, requestCode)
		infoIntent.putExtra(NOTIFICATION_CONTENT, content)
		infoIntent.putExtra(NOTIFICATION_TITLE, title)
		infoIntent.putExtra(NOTIFICATION_ICON, icon)

		val calendar: Calendar = Calendar.getInstance().apply {
			timeInMillis = System.currentTimeMillis()
			set(Calendar.HOUR_OF_DAY, hour)
			set(Calendar.MINUTE, minute)
		}

		var alarmManager = context.getSystemService(Context.ALARM_SERVICE) as AlarmManager;
		var pendingIntent = PendingIntent.getBroadcast(context, requestCode, infoIntent,
			PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE)
		alarmManager.setInexactRepeating(AlarmManager.RTC_WAKEUP, calendar.timeInMillis, intervalInMs, pendingIntent)

		val formatter = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")

		Utils.log("Scheduled notification for requestCode $requestCode starting on ${formatter.format(calendar.time)}")
	}
}
